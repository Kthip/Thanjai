<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a2f8f" />
  <title>Thunjai Express ‚Äî Rider</title>
  <style>
    :root{
  --brand:#ffd54d; --brand-blue:#0a2f8f; --brand-soft:#fff6cc;
  --ink:#0b1726; --bg:#ffffff; --muted:#475569; --line:#d5dbe3;
  --radius:18px; --hdr:56px; --bnv:64px; --maxw:480px;
  --focus:#94a3b8; 
  --focus-ring: 0 0 0 3px rgba(148,163,184,.35);
}
    *{box-sizing:border-box}
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--ink);line-height:1.45;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--ink)}

    .app{min-height:100dvh;display:flex;flex-direction:column;align-items:center;background:linear-gradient(180deg,#0a2f8f 0%,#0a2f8f 180px,var(--bg) 180px)}
    .phone{width:100%;max-width:var(--maxw);min-height:100dvh;background:#fff;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(10,47,143,.08)}

    header{height:var(--hdr);display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:#fff;position:sticky;top:0;z-index:5;border-bottom:1px solid var(--line)}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{inline-size:34px;block-size:34px;border-radius:10px;background:var(--brand);display:grid;place-items:center}
    .logo svg{width:20px;height:20px;color:#0a2f8f}
    .brand h1{font-size:1.05rem;margin:0;color:#0a2f8f}
    .role-chip{font-size:.72rem;background:var(--brand-soft);padding:.2rem .5rem;border-radius:999px;color:#7a6400;border:1px solid #f6d971}
    .hdr-actions{display:flex;gap:8px}
    .iconbtn{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;display:grid;place-items:center;cursor:pointer}
    .iconbtn:active{transform:scale(.98)}

    .content{flex:1;overflow:auto;padding:16px;display:none}
    .content.active{display:block}

    .grid{display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:14px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;min-width:0}
    .pill{font-size:.75rem;background:#f8fafc;border:1px solid var(--line);padding:.2rem .5rem;border-radius:999px;color:#0b2b27}
    .big{font-size:1.4rem;font-weight:800}
    .muted{color:var(--muted);font-size:.85rem}

    /* Chips */
    .chips{display:flex;gap:8px;overflow:auto hidden;white-space:nowrap;flex:1 1 auto;padding-bottom:4px;scrollbar-width:none}
    .chips::-webkit-scrollbar{display:none}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 11px;border-radius:999px;background:#f3f4f6;border:1px solid #d7dde6;font-size:.82rem;font-weight:650;color:#1f2937;cursor:pointer;flex:0 0 auto}
    .chip[aria-pressed="true"]{background:#dbeafe;border-color:#bfd7ff;color:#0a2f8f}
    /* ‚úÖ ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ History ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
    .chips.small .chip{padding:4px 8px;font-size:.7rem}

    /* Job cards */
    .job{display:grid;gap:6px;border:1px solid var(--line);border-radius:12px;padding:10px}
    .job .meta{display:flex;gap:6px;flex-wrap:wrap}
    .job .meta .tag{font-size:.7rem;background:#eef2ff;border:1px solid #dbe2ff;color:#223;padding:.15rem .45rem;border-radius:999px}
    .job .addr{font-size:.85rem}
    .job .act{display:flex;gap:6px;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;font-size:.85rem;cursor:pointer}
    .btn.primary{background:var(--brand-blue);color:#fff}
    .btn.warn{background:#ffeee8;color:#b42318;border:1px solid #ffd2c4}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:#0a2f8f}
    .btn.small{padding:6px 8px;font-weight:600;font-size:.8rem}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th{font-size:.75rem;text-align:left;color:#334155;font-weight:600}
    td{background:#fff;border:1px solid var(--line);padding:6px 8px;border-radius:8px;font-size:.8rem}

    /* Bottom nav */
    nav.bnv{
      height:var(--bnv);position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);
      display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr))
    }
    .tab{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:3px;
  color:#1f2937;
  font-size:.8rem;
  font-weight:600;
  cursor:pointer;
  padding:8px 4px;
  transition:background .2s, color .2s;
  background:#f9fafb;       /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á */
}
.tab:hover{
  background:#e5e7eb;       /* hover ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏Å‡∏ß‡πà‡∏≤ */
}
.tab.active{
  background:var(--brand-blue);  /* ‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ active */
  color:#ffffff;                 /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
  font-weight:700;
}

    .fab{position:fixed;inset:auto calc(50% - 40px) 82px auto;width:80px;height:40px;border-radius:999px;background:var(--brand);display:flex;align-items:center;justify-content:center;gap:6px;font-weight:700;color:#0b2b27;border:1px solid #f2c93b;cursor:pointer;font-size:.85rem}
    .fab:active{transform:translateY(1px)}

    /* Event badges for history */
    .ev{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.72rem;font-weight:700;border:1px solid transparent}
    .ev.DELIVERED{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .ev.PICKED{background:#eff6ff;color:#1e40af;border-color:#c7d2fe}
    .ev.ACCEPTJOB{background:#f0f9ff;color:#075985;border-color:#bae6fd}
    .ev.REJECTJOB{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .ev.PICKUPDONE{background:#f5f3ff;color:#5b21b6;border-color:#ddd6fe}
    .ev.DELIVERYFAILED{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .ev.SCAN{background:#f1f5f9;color:#334155;border-color:#e2e8f0}

    /* History fit-to-screen */
    #tab-history { padding: 6px 12px 12px; }
    .hist-layout{height:calc(100dvh - var(--hdr) - var(--bnv));display:flex;flex-direction:column;gap:6px;}
    .hist-toolbar{position:sticky;top:0;z-index:3;background:#fff;border:1px solid var(--line);border-radius:12px;padding:6px;}
    .hist-bar,.hist-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .stat-cards.compact{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    .stat.compact{background:#f8fafc;border:1px solid var(--line);border-radius:10px;padding:6px;text-align:center}
    .stat.compact .num{font-weight:800;font-size:.95rem}
    .stat.compact .lbl{font-size:.7rem;color:#64748b}
    .hist-scroll{flex:1;min-height:0;overflow:auto;display:block}
    .card.hist-list{margin:0;padding:10px}
    .hist-scroll table thead th{position:sticky;top:0;z-index:1;background:#fff}
    #histTable td,#histTable th{padding:6px 8px;font-size:.78rem}
    #histTable td.muted{font-size:.75rem;color:#64748b}
    .empty{padding:16px;border:1px dashed var(--line);border-radius:10px;text-align:center;color:#64748b}

    /* Modal (Fullscreen) */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.58);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .sheet{width:100%;max-width:var(--maxw);height:92dvh;background:#fff;border-radius:20px;display:flex;flex-direction:column;overflow:hidden}
    .sheet header{position:relative}
    .sheet header h2{font-size:1rem;color:#0a2f8f}
    .sheet .body{flex:1;padding:16px;overflow:auto}

    /* Dark mode */
    @media (prefers-color-scheme: dark){
      body{background:#0b1020;color:#e5e7eb

  /* Bottom tabs - Dark Mode */
  .tab{background:#172033;color:#e5eaf3;}
  .tab:hover{background:#20324e;}
  .tab.active{background:var(--brand-blue);color:#ffffff;font-weight:700;}
}
      .phone{background:#0f152a}
      header,.card,input,textarea,select,td{background:#0f152a;color:#e5e7eb;border-color:#223}
      nav.bnv{background:#0f152a;border-color:#223}
      .iconbtn{background:#0f152a;border-color:#223}
      .fab{border-color:#d4b534}
      .job{border-color:#223}
      .chip{background:#1b2035;border-color:#2a2f46;color:#cbd5e1}
      .chip[aria-pressed="true"]{background:#2b3a5a;border-color:#3c4b6c;color:#f0f6ff}
      .hist-toolbar{background:#0f152a;border-color:#223}
      .stat.compact{background:#101935;border-color:#223}
      .hist-scroll table thead th{background:#0f152a}
      .sheet{background:#0f152a}
    }
  
a, button, input, select, textarea {outline: none;}
a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
  box-shadow: var(--focus-ring);
  border-color: var(--focus);
}
</style>
</head>
<body>
  <div class="app">
    <div class="phone">
      <header>
        <div class="brand">
          <div class="logo" aria-label="Thunjai Express">
             <a href="home.html" class="logo" aria-label="Thunjai Express">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M13 2 3 14h7l-1 8 10-12h-7l1-8z"/>
      </svg>
    </a>
          </div>
          <div>
            <div class="role-chip">Role: Rider</div>
            <h1>Thunjai Express</h1>
          </div>
        </div>
        <div class="hdr-actions">
          <button class="iconbtn" title="‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô" onclick="toggleShift()">üü¢</button>
          <button class="iconbtn" title="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô" onclick="toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà')">üîî</button>
          <button class="iconbtn" title="‡∏™‡πÅ‡∏Å‡∏ô" onclick="openScan()">üì∑</button>
        </div>
      </header>

      <!-- TAB: Pickup -->
      <section id="tab-pickup" class="content active">
        <div class="grid">
          <div class="row">
            <h3>‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (Pickup)</h3>
            <span class="pill" id="shiftState">On Duty</span>
          </div>
          <div class="row">
            <div class="chips" role="toolbar" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Pickup">
              <button class="chip" id="chip-Pickup-ALL"      aria-pressed="true"  onclick="setStatus('Pickup','ALL')">ALL (0)</button>
              <button class="chip" id="chip-Pickup-NEW"      aria-pressed="false" onclick="setStatus('Pickup','NEW')">NEW (0)</button>
              <button class="chip" id="chip-Pickup-ACCEPTED" aria-pressed="false" onclick="setStatus('Pickup','ACCEPTED')">ACCEPTED (0)</button>
              <button class="chip" id="chip-Pickup-PICKED"   aria-pressed="false" onclick="setStatus('Pickup','PICKED')">PICKED (0)</button>
              <button class="chip" id="chip-Pickup-DONE"     aria-pressed="false" onclick="setStatus('Pickup','DONE')">DONE (0)</button>
            </div>
            <button class="btn small ghost" onclick="sortJobs('Pickup')">‡∏à‡∏±‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
          </div>
          <div class="card">
            <div class="row">
              <div class="muted">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏±‡∏ö: <b id="cnt-Pickup">0</b> | ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: <b id="done-Pickup">0</b></div>
            </div>
          </div>
          <div id="jobList-Pickup" class="grid" style="gap:10px"></div>
        </div>
      </section>

      <!-- TAB: Delivery -->
      <section id="tab-delivery" class="content">
        <div class="grid">
          <div class="row">
            <h3>‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (Delivery)</h3>
            <span class="pill">COD: <b id="earn">‡∏ø0</b></span>
          </div>
          <div class="row">
            <div class="chips" role="toolbar" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Delivery">
              <button class="chip" id="chip-Delivery-ALL"      aria-pressed="true"  onclick="setStatus('Delivery','ALL')">ALL (0)</button>
              <button class="chip" id="chip-Delivery-NEW"      aria-pressed="false" onclick="setStatus('Delivery','NEW')">NEW (0)</button>
              <button class="chip" id="chip-Delivery-ACCEPTED" aria-pressed="false" onclick="setStatus('Delivery','ACCEPTED')">ACCEPTED (0)</button>
              <button class="chip" id="chip-Delivery-PICKED"   aria-pressed="false" onclick="setStatus('Delivery','PICKED')">PICKED (0)</button>
              <button class="chip" id="chip-Delivery-DONE"     aria-pressed="false" onclick="setStatus('Delivery','DONE')">DONE (0)</button>
            </div>
            <button class="btn small ghost" onclick="sortJobs('Delivery')">‡∏à‡∏±‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
          </div>
          <div class="card">
            <div class="row">
              <div class="muted">‡∏Ñ‡∏¥‡∏ß‡∏™‡πà‡∏á: <b id="cnt-Delivery">0</b> | ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <b id="done-Delivery">0</b></div>
            </div>
          </div>
          <div id="jobList-Delivery" class="grid" style="gap:10px"></div>
        </div>
      </section>

      <!-- TAB: Route -->
      <section id="tab-route" class="content">
        <div class="card">
          <h3>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
          <p class="muted">*‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‚Äî ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Maps/Leaflet ‡πÑ‡∏î‡πâ</p>
          <div style="aspect-ratio:3/4;border:2px dashed var(--line);border-radius:14px;display:grid;place-items:center;margin-top:12px">üó∫Ô∏è ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" onclick="toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
            <button class="btn primary" onclick="sortJobs()">‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÅ‡∏ß‡∏∞</button>
          </div>
        </div>
      </section>

      <!-- TAB: Scan -->
      <section id="tab-scan" class="content">
        <div class="card" style="margin-bottom:12px">
          <h3>‡∏™‡πÅ‡∏Å‡∏ô / ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
          <div class="row">
            <button class="btn primary" onclick="openScan()">‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ö/‡∏™‡πà‡∏á</button>
            <button class="btn ghost" onclick="clearScanLog()">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
          </div>
        </div>
        <table>
          <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏•‡∏Ç</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</th></tr></thead>
          <tbody id="scanLog"></tbody>
        </table>
      </section>

      <!-- TAB: History (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠) -->
      <section id="tab-history" class="content">
        <div class="hist-layout">

          <div class="hist-toolbar">
            <div class="hist-bar">
              <div class="row" style="gap:8px">
                <!-- ‚úÖ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
                <input id="histDate" type="date" />
                <input id="histSearch" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ / ‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà"
                       style="flex:1;min-width:180px;padding:9px 12px;border-radius:12px;border:1px solid var(--line)">
                <div class="row">
                  <button id="btnViewTimeline" class="btn small ghost" onclick="setHistView('timeline')">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</button>
                  <button id="btnViewGroup"    class="btn small ghost" onclick="setHistView('group')">‡∏à‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
                </div>
              </div>
            </div>

            <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á -->
            <div class="hist-row" style="margin-top:8px">
              <div id="histChips" class="chips small" role="toolbar" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (History)"></div>
              <div class="pill">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: <b id="histCnt">0</b></div>
            </div>
          </div>

          <div class="stat-cards compact">
            <div class="stat compact"><div class="num" id="statAll">0</div><div class="lbl">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏ß‡∏°</div></div>
            <div class="stat compact"><div class="num" id="statDelivered">0</div><div class="lbl">‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>
            <div class="stat compact"><div class="num" id="statCOD">‡∏ø0</div><div class="lbl">COD ‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô</div></div>
          </div>

          <div class="hist-scroll">
            <div class="card hist-list">
              <div class="row" style="margin-bottom:6px">
                <h3 style="margin:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå <span class="muted" id="histDateLabel">‚Äî</span></h3>
              </div>

              <div id="histContainer">
                <table id="histTableWrap" style="width:100%">
                  <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>COD</th></tr></thead>
                  <tbody id="histTable"></tbody>
                </table>
              </div>

              <div id="histEmpty" class="empty" style="display:none">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
          </div>

        </div>
      </section>

      <!-- TAB: COD -->
      <section id="tab-cod" class="content">
        <div class="grid">
          <div class="card">
            <h3>‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î COD</h3>
            <div class="row"><div class="big" id="codTotal">‡∏ø0</div><span class="pill">‡∏™‡∏∞‡∏™‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" onclick="reconcileCOD()">‡∏™‡πà‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ Hub</button>
              <button class="btn ghost" onclick="toast('‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏•‡∏¥‡∏õ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)')">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏•‡∏¥‡∏õ</button>
            </div>
          </div>
          <div class="card">
            <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
            <div id="codList" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
          </div>
        </div>
      </section>

      <!-- TAB: Profile -->
      <section id="tab-profile" class="content">
        <div class="grid">
          <div class="card">
            <h3>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
            <div class="row"><span>‡∏ä‡∏∑‡πà‡∏≠</span><b>‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏±‡∏ô‡∏¢‡πå‡πÉ‡∏à</b></div>
            <div class="row"><span>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</span><b>‡∏Å‡∏Ç-1234</b></div>
            <div class="row"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏</span><b id="capacity">12 ‡∏Å‡∏•‡πà‡∏≠‡∏á</b></div>
            <div class="row"><span>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span><b>‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ / ‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç</b></div>
          </div>
          <div class="card">
            <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
            <div class="row">
              <span>‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
              <button class="btn small ghost" onclick="toggleShift()">‡∏™‡∏•‡∏±‡∏ö</button>
            </div>
            <div class="row">
              <span>‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
              <button class="btn small ghost" onclick="toast('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)')">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î</button>
            </div>
          </div>
        </div>
      </section>

      <button class="fab" onclick="openScan()">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button>

      <!-- Bottom Nav -->
      <nav class="bnv" role="tablist" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å">
        <div class="tab active" data-tab="pickup"   onclick="switchTab(this)">üì¶<span>Pickup</span></div>
        <div class="tab"         data-tab="delivery" onclick="switchTab(this)">üöö<span>Delivery</span></div>
        <div class="tab"         data-tab="route"    onclick="switchTab(this)">üó∫Ô∏è<span>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</span></div>
        <div class="tab"         data-tab="scan"     onclick="switchTab(this)">üì∑<span>‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏î</span></div>
        <div class="tab"         data-tab="history"  onclick="switchTab(this)">üóÇÔ∏è<span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span></div>
        <div class="tab"         data-tab="cod"      onclick="switchTab(this)">üíº<span>COD</span></div>
        <div class="tab"         data-tab="profile"  onclick="switchTab(this)">üë§<span>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></div>
      </nav>

      <!-- Fullscreen Modal: Scanner/Camera -->
      <div id="scanModal" class="modal" aria-hidden="true">
        <div class="sheet">
          <header>
            <div class="brand" style="padding:0 14px;gap:8px">
              <div class="logo"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2 3 14h7l-1 8 10-12h-7l1-8z"/></svg></div>
              <h2>‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏ / ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</h2>
            </div>
          </header>
          <div class="body">
            <div class="card" style="text-align:center">
              <p class="muted">*‡πÄ‡∏î‡πÇ‡∏°: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á</p>
              <div style="aspect-ratio:16/9;border:2px dashed var(--line);border-radius:14px;display:grid;place-items:center;margin-top:12px">üî≤ ‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
              <div class="row" style="justify-content:center;margin-top:12px">
                <button class="btn ghost" onclick="closeScan()">‡∏õ‡∏¥‡∏î</button>
                <button class="btn primary" onclick="mockScan()">‡∏™‡πÅ‡∏Å‡∏ô</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ===== Utilities =====
    function switchTab(el){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
      el.classList.add('active')
      const tab = el.dataset.tab
      document.querySelectorAll('.content').forEach(s=>s.classList.remove('active'))
      document.getElementById('tab-'+tab).classList.add('active')
      document.getElementById('tab-'+tab).scrollTop = 0
    }
    function toast(msg){
      const t = document.createElement('div')
      t.textContent = msg
      t.style.cssText = 'position:fixed;left:50%;bottom:92px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;z-index:99'
      document.body.appendChild(t)
      setTimeout(()=>t.remove(), 1800)
    }
    const TH = 'th-TH'

    // ===== Shift =====
    let onDuty = true
    function toggleShift(){
      onDuty = !onDuty
      document.getElementById('shiftState').textContent = onDuty ? 'On Duty' : 'Off Duty'
      toast(onDuty ? '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô' : '‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô')
    }

    // ===== Data =====
    const jobs = [
      { id:'TJX1001', type:'Pickup',   name:'‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏ó‡∏µ', phone:'081-234-5678', addr:'‡∏ã.‡∏™‡∏∏‡∏Ç‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå 14, ‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ', note:'‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á 2 ‡∏Å‡∏•‡πà‡∏≠‡∏á', cod:0,   status:'NEW' },
      { id:'TJX1002', type:'Delivery', name:'‡∏Ñ‡∏∏‡∏ì‡∏î‡∏≤‡∏ß', phone:'089-222-1111', addr:'‡∏ã.‡πÄ‡∏≠‡∏Å‡∏ä‡∏±‡∏¢ 55, ‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô',   note:'‡∏™‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô',       cod:450, status:'NEW' },
      { id:'TJX1003', type:'Delivery', name:'‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£',  phone:'082-999-3344', addr:'‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 2 ‡∏ã.20',         note:'‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡∏Å‡∏´‡∏±‡∏Å‡∏á‡πà‡∏≤‡∏¢', cod:0,   status:'ACCEPTED' },
      { id:'TJX1004', type:'Pickup',   name:'‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏≠‡∏™', phone:'081-777-2222', addr:'‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏° 69',            note:'1 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å',   cod:0,   status:'PICKED' },
      { id:'TJX1005', type:'Delivery', name:'‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≤‡∏ô', phone:'081-345-9999', addr:'‡πÄ‡∏≠‡∏Å‡∏ä‡∏±‡∏¢ 76',              note:'COD',           cod:300, status:'PICKED' },
      { id:'TJX1006', type:'Pickup',   name:'‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏ö',  phone:'080-333-2222', addr:'‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠',             note:'4 ‡∏Å‡∏•‡πà‡∏≠‡∏á',       cod:0,   status:'DONE' },
    ]
    let earn = 0
    const statusBySeg = { Pickup:'ALL', Delivery:'ALL' }
    const STATUSES = ['ALL','NEW','ACCEPTED','PICKED','DONE']

    // ===== History store =====
    const scanEvents = [] // {time:Date, id:string, event:string}

    // ===== Helpers =====
    function getRows(seg, st){
      let rows = jobs.filter(j=>j.type===seg)
      if(st && st!=='ALL') rows = rows.filter(j=>j.status===st)
      return rows
    }
    function countByStatus(seg){
      const all = jobs.filter(j=>j.type===seg)
      return {
        ALL: all.length,
        NEW: all.filter(j=>j.status==='NEW').length,
        ACCEPTED: all.filter(j=>j.status==='ACCEPTED').length,
        PICKED: all.filter(j=>j.status==='PICKED').length,
        DONE: all.filter(j=>j.status==='DONE').length,
      }
    }
    function updateChipCounts(seg){
      const c = countByStatus(seg)
      STATUSES.forEach(s=>{
        const chip = document.getElementById(`chip-${seg}-${s}`)
        if(chip){
          chip.innerText = `${s} (${c[s]})`
          chip.setAttribute('aria-pressed', statusBySeg[seg]===s ? 'true' : 'false')
        }
      })
    }
    function jobById(id){ return jobs.find(j=>j.id===id) }
    function jobByIdOrPartial(id){ return jobs.find(j=>j.id===id) || {} }

    function jobCardHTML(j){
      const isDelivery = j.type==='Delivery'
      const scanLabelAccepted = isDelivery ? '‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô' : '‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô'
      return `
        <div class="job" id="job-${j.id}">
          <div class="row">
            <b>${j.id}</b>
            <span class="tag">${j.type}</span>
          </div>
          <div class="addr">üìç ${j.addr}</div>
          <div class="meta">
            <span class="tag">üë§ ${j.name}</span>
            <span class="tag">üìû ${j.phone}</span>
            ${j.cod?`<span class="tag">COD ‡∏ø${j.cod}</span>`:''}
            <span class="tag">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${j.status}</span>
          </div>
          <div class="act">
            ${j.status==='NEW' ? `
              <button class="btn small primary" onclick="acceptJob('${j.id}')">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>
              <button class="btn small ghost"   onclick="rejectJob('${j.id}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
            `: ''}
            ${j.status==='ACCEPTED' ? `
              <button class="btn small primary" onclick="updateJob('${j.id}','PICKED')">${scanLabelAccepted}</button>
              <button class="btn small ghost"   onclick="navigate('${j.id}')">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
            `: ''}
            ${j.status==='PICKED' ? `
              ${isDelivery
                ? `<button class="btn small primary" onclick="deliver('${j.id}', true)">‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>
                   <button class="btn small warn"    onclick="deliver('${j.id}', false)">‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>`
                : `<button class="btn small primary" onclick="finishPickup('${j.id}')">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</button>`}
            `: ''}
            ${j.status==='DONE' ? `<span class="muted">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>`: ''}
          </div>
        </div>`
    }

    function renderSegment(seg){
      updateChipCounts(seg)
      const st = statusBySeg[seg]
      const rows = getRows(seg, st)

      const doneCnt = jobs.filter(j=>j.type===seg && j.status==='DONE').length
      const waitingCnt = rows.filter(j=>j.status!=='DONE').length
      document.getElementById(`cnt-${seg}`).textContent  = (st==='DONE') ? rows.length : waitingCnt
      document.getElementById(`done-${seg}`).textContent = doneCnt
      if(seg==='Delivery'){
        document.getElementById('earn').textContent = '‡∏ø'+ earn.toLocaleString(TH)
      }
      const box = document.getElementById(`jobList-${seg}`)
      box.innerHTML = rows.length ? rows.map(jobCardHTML).join('') : `<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`
    }
    function renderAll(){ renderSegment('Pickup'); renderSegment('Delivery'); }

    // ===== Actions (with history log) =====
    function acceptJob(id){
      const j = jobById(id); if(!j) return
      j.status = 'ACCEPTED'
      renderAll(); logScan(j.id,'ACCEPT JOB')
    }
    function rejectJob(id){
      const idx = jobs.findIndex(x=>x.id===id); if(idx<0) return
      logScan(jobs[idx].id,'REJECT JOB')
      jobs.splice(idx,1)
      renderAll()
    }
    function updateJob(id, status){
      const j = jobById(id); if(!j) return
      j.status = status
      renderAll(); logScan(j.id,status) // 'PICKED'
    }
    function finishPickup(id){
      const j = jobById(id); if(!j) return
      j.status = 'DONE'
      renderAll(); logScan(j.id,'PICKUP DONE')
    }
    function deliver(id, success){
      const j = jobById(id); if(!j) return
      j.status = 'DONE'
      if(success){
        earn += j.cod||0
        document.getElementById('codTotal').textContent = '‡∏ø'+ earn.toLocaleString(TH)
        addCODCustomer(j)
      }
      renderAll(); logScan(j.id, success?'DELIVERED':'DELIVERY FAILED')
    }
    function navigate(id){
      const j = jobById(id); if(!j) return
      toast('‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á: '+ j.addr)
    }

    // ===== Filters per tab =====
    function setStatus(seg, st){
      if(!STATUSES.includes(st)) st='ALL'
      statusBySeg[seg] = st
      renderSegment(seg)
    }

    // ===== Scan modal & log =====
    function openScan(){ document.getElementById('scanModal').classList.add('open'); document.getElementById('scanModal').setAttribute('aria-hidden','false') }
    function closeScan(){ document.getElementById('scanModal').classList.remove('open'); document.getElementById('scanModal').setAttribute('aria-hidden','true') }
    function logScan(no, evt){
      const tb = document.getElementById('scanLog')
      const t  = new Date()
      const tStr = t.toLocaleString(TH)
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${tStr}</td><td>${no}</td><td>${evt}</td>`
      tb.prepend(tr)
      scanEvents.push({ time: t, id: no, event: evt })
      if(document.getElementById('tab-history').classList.contains('active')) renderHistory()
    }
    function mockScan(){
      closeScan(); toast('‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)');
      logScan('TJX'+Math.random().toString(36).slice(2,7).toUpperCase(),'SCAN')
    }
    function clearScanLog(){
      document.getElementById('scanLog').innerHTML = ''
      scanEvents.length = 0
      if(document.getElementById('tab-history').classList.contains('active')) renderHistory()
    }

    // ===== COD =====
    function addCODCustomer(j){
      const box = document.getElementById('codList')
      if(box.textContent.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')) box.textContent=''
      const div = document.createElement('div')
      div.className='row'
      div.innerHTML = `<span>${j.id} ‚Ä¢ ${j.name}</span><b>‡∏ø${(j.cod||0).toLocaleString(TH)}</b>`
      box.appendChild(div)
    }
    function reconcileCOD(){
      const t = new Date().toLocaleString(TH)
      toast('‡∏™‡πà‡∏á‡∏¢‡∏≠‡∏î COD ‡πÄ‡∏Ç‡πâ‡∏≤ Hub ‡πÅ‡∏•‡πâ‡∏ß '+t)
    }

    // ===== History state & helpers =====
    const histEventOptions = [
      'ALL','DELIVERED','PICKED','ACCEPT JOB','REJECT JOB','PICKUP DONE','DELIVERY FAILED','SCAN'
    ]
    let histEventFilter = 'ALL'
    let histViewMode = 'timeline' // 'timeline' | 'group'
    let histSearchQuery = ''

    function yyyy_mm_dd(d){
      const y = d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0')
      return `${y}-${m}-${day}`
    }
    function parseDateInput(v){ return new Date(v+'T00:00') }
    function eventClass(name){
      const k = String(name).toUpperCase().replace(/\s+/g,'')
      return ['ev', k].join(' ')
    }

    function countEventsForDate(ymd){
      const res = {}; let all=0, delivered=0, cod=0
      scanEvents.forEach(e=>{
        if(yyyy_mm_dd(e.time)!==ymd) return
        all++
        res[e.event] = (res[e.event]||0)+1
        const j = jobByIdOrPartial(e.id)
        const isDelivery = (j.type==='Delivery')
        if(e.event==='DELIVERED' && isDelivery){
          delivered++
          cod += (j.cod||0)
        }
      })
      res.__ALL__ = all; res.__DELIVERED__ = delivered; res.__COD__ = cod
      histEventOptions.forEach(k=>{ if(!(k in res) && k!=='ALL') res[k]=0 })
      return res
    }

    function renderHistChips(){
      const ymd = document.getElementById('histDate').value
      const counts = countEventsForDate(ymd)
      const wrap = document.getElementById('histChips')
      wrap.innerHTML = histEventOptions.map(name=>{
        const n = name==='ALL' ? (counts.__ALL__||0) : (counts[name]||0)
        return `<button class="chip" data-name="${name}" aria-pressed="${histEventFilter===name?'true':'false'}"
                  onclick="setHistEventFilter('${name.replace(/'/g,"\\'")}')">${name} (${n})</button>`
      }).join('')
      document.getElementById('statAll').textContent = counts.__ALL__||0
      document.getElementById('statDelivered').textContent = counts.__DELIVERED__||0
      document.getElementById('statCOD').textContent = '‡∏ø'+ (counts.__COD__||0).toLocaleString(TH)
    }

    // ===== History interactions =====
    function setHistEventFilter(name){
      if(!histEventOptions.includes(name)) name='ALL'
      histEventFilter = name
      renderHistory()
    }
    function setHistView(mode){
      histViewMode = mode==='group' ? 'group' : 'timeline'
      document.getElementById('btnViewTimeline').className = 'btn small ' + (histViewMode==='timeline'?'primary':'ghost')
      document.getElementById('btnViewGroup').className    = 'btn small ' + (histViewMode==='group'?'primary':'ghost')
      renderHistory()
    }

    // ===== History render core =====
    function renderHistory(){
      const inp = document.getElementById('histDate')
      const sel = inp.value; if(!sel) return

      renderHistChips()

      let rowsAll = scanEvents.filter(e => yyyy_mm_dd(e.time)===sel)
                              .sort((a,b)=> b.time - a.time)

      const q = (histSearchQuery||'').trim().toLowerCase()
      if(q){
        rowsAll = rowsAll.filter(e=>{
          const j = jobByIdOrPartial(e.id)
          return [e.id, j.name, j.phone, j.addr].some(v => (v||'').toLowerCase().includes(q))
        })
      }

      const rows = histEventFilter==='ALL' ? rowsAll : rowsAll.filter(e=> e.event===histEventFilter)

      document.getElementById('histDateLabel').textContent =
        new Date(sel+'T00:00').toLocaleDateString(TH, {year:'numeric',month:'short',day:'numeric'})
      document.getElementById('histCnt').textContent = rows.length
      const empty = document.getElementById('histEmpty')
      const tableWrap = document.getElementById('histTableWrap')
      empty.style.display = rows.length ? 'none' : 'block'
      tableWrap.style.display = (rows.length && histViewMode==='timeline') ? '' : (histViewMode==='timeline'?'none':'')

      if(histViewMode==='timeline'){
        const tbody = document.getElementById('histTable')
        tbody.innerHTML = rows.map(e=>{
          const j = jobByIdOrPartial(e.id)
          const isDelivery = (j.type==='Delivery')
          const cod = (e.event==='DELIVERED' && isDelivery) ? (j.cod||0) : 0
          const lines = [
            j.note ? `‡πÇ‡∏ô‡πâ‡∏ï: ${j.note}` : '',
            j.addr ? `‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${j.addr}` : ''
          ].filter(Boolean).join('<br>')
          return `<tr>
            <td>${e.time.toLocaleTimeString(TH,{hour:'2-digit',minute:'2-digit'})}</td>
            <td>${e.id}</td>
            <td>${j.type||'-'}</td>
            <td><span class="${eventClass(e.event)}">${e.event}</span></td>
            <td class="muted">${lines||'-'}</td>
            <td>${cod? '‡∏ø'+cod.toLocaleString(TH): '-'}</td>
          </tr>`
        }).join('')
      } else {
        const container = document.getElementById('histContainer')
        const groups = {}
        rows.forEach(e => { (groups[e.event] ||= []).push(e) })
        const ordered = histEventOptions.filter(s=>s!=='ALL').filter(s=>groups[s]?.length).concat(
          Object.keys(groups).filter(k=>!histEventOptions.includes(k))
        )
        container.innerHTML = ordered.length ? ordered.map(evt=>{
          const items = groups[evt].sort((a,b)=>b.time-a.time).map(e=>{
            const j = jobByIdOrPartial(e.id)
            const isDelivery = (j.type==='Delivery')
            const cod = (e.event==='DELIVERED' && isDelivery) ? (j.cod||0) : 0
            return `<div class="row" style="padding:8px 0;border-bottom:1px dashed var(--line)">
              <div style="min-width:72px">${e.time.toLocaleTimeString(TH,{hour:'2-digit',minute:'2-digit'})}</div>
              <div style="flex:1">
                <div><b>${e.id}</b> ‚Ä¢ <span class="muted">${j.type||'-'}</span></div>
                <div class="muted" style="font-size:.82rem">${j.addr||''}</div>
              </div>
              <div>${cod? '‡∏ø'+cod.toLocaleString(TH): ''}</div>
            </div>`
          }).join('')
          return `
            <div class="card" style="margin-top:10px">
              <div class="row"><h4 style="margin:0"><span class="${eventClass(evt)}">${evt}</span></h4><span class="pill">${groups[evt].length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div>
              <div style="margin-top:6px">${items}</div>
            </div>`
        }).join('') : '<div class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>'
        document.getElementById('histTable').innerHTML = ''
      }

      const counts = countEventsForDate(sel)
      document.getElementById('statAll').textContent = counts.__ALL__||0
      document.getElementById('statDelivered').textContent = counts.__DELIVERED__||0
      document.getElementById('statCOD').textContent = '‡∏ø'+ (counts.__COD__||0).toLocaleString(TH)
    }

    // ===== History bindings =====
    function bindHistoryUI(){
      const inp = document.getElementById('histDate')
      inp.value = yyyy_mm_dd(new Date())
      inp.addEventListener('change', ()=>{ renderHistory() })

      const search = document.getElementById('histSearch')
      let t=null
      search.addEventListener('input', e=>{
        clearTimeout(t)
        t = setTimeout(()=>{
          histSearchQuery = e.target.value||''
          renderHistory()
        }, 180)
      })

      setHistView('timeline')
      renderHistory()
    }

    // ===== Sorting demo =====
    function sortJobs(seg){
      if(!seg){
        jobs.sort((a,b)=> (a.type==='Delivery') - (b.type==='Delivery'))
      }else{
        const order = {NEW:1, ACCEPTED:2, PICKED:3, DONE:4}
        jobs.sort((a,b)=>{
          if(a.type!==seg || b.type!==seg) return 0
          return (order[a.status]||9) - (order[b.status]||9)
        })
      }
      renderAll()
      toast('‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)')
    }

    // ===== Init =====
    renderAll()
    bindHistoryUI()
  </script>
</body>
</html>
