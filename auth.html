<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a2f8f" />
  <title>Thunjai Express — Rider</title>
  <style>
    :root{
      --brand:#ffd54d; --brand-blue:#0a2f8f; --brand-soft:#fff6cc;
      --ink:#0b2b27; --bg:#f6f8fb; --muted:#64748b; --line:#e5e7eb;
      --radius:18px; --hdr:56px; --bnv:64px; --maxw:480px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--ink)}

    .app{min-height:100dvh;display:flex;flex-direction:column;align-items:center;background:linear-gradient(180deg,#0a2f8f 0%,#0a2f8f 180px,var(--bg) 180px)}
    .phone{width:100%;max-width:var(--maxw);min-height:100dvh;background:#fff;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(10,47,143,.08)}

    header{height:var(--hdr);display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:#fff;position:sticky;top:0;z-index:5;border-bottom:1px solid var(--line)}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{inline-size:34px;block-size:34px;border-radius:10px;background:var(--brand);display:grid;place-items:center}
    .logo svg{width:20px;height:20px;color:#0a2f8f}
    .brand h1{font-size:1.05rem;margin:0;color:#0a2f8f}
    .role-chip{font-size:.72rem;background:var(--brand-soft);padding:.2rem .5rem;border-radius:999px;color:#7a6400;border:1px solid #f6d971}
    .hdr-actions{display:flex;gap:8px}
    .iconbtn{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;display:grid;place-items:center;cursor:pointer}
    .iconbtn:active{transform:scale(.98)}

    .content{flex:1;overflow:auto;padding:16px;display:none}
    .content.active{display:block}

    .grid{display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:14px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;min-width:0}
    .pill{font-size:.75rem;background:#f8fafc;border:1px solid var(--line);padding:.2rem .5rem;border-radius:999px;color:#0b2b27}
    .big{font-size:1.4rem;font-weight:800}
    .muted{color:var(--muted);font-size:.85rem}

    /* Chips */
    .chips{display:flex;gap:8px;overflow:auto hidden;white-space:nowrap;flex:1 1 auto;padding-bottom:4px;scrollbar-width:none}
    .chips::-webkit-scrollbar{display:none}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f8fafc;border:1px solid var(--line);font-size:.8rem;font-weight:600;color:#334155;cursor:pointer;flex:0 0 auto}
    .chip[aria-pressed="true"]{background:#e8f0ff;border-color:#cfe0ff;color:#0a2f8f}
    /* ✅ เวอร์ชันเล็กใช้ในหน้า History เท่านั้น */
    .chips.small .chip{padding:4px 8px;font-size:.7rem}

    /* Job cards */
    .job{display:grid;gap:6px;border:1px solid var(--line);border-radius:12px;padding:10px}
    .job .meta{display:flex;gap:6px;flex-wrap:wrap}
    .job .meta .tag{font-size:.7rem;background:#eef2ff;border:1px solid #dbe2ff;color:#223;padding:.15rem .45rem;border-radius:999px}
    .job .addr{font-size:.85rem}
    .job .act{display:flex;gap:6px;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;font-size:.85rem;cursor:pointer}
    .btn.primary{background:var(--brand-blue);color:#fff}
    .btn.warn{background:#ffeee8;color:#b42318;border:1px solid #ffd2c4}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:#0a2f8f}
    .btn.small{padding:6px 8px;font-weight:600;font-size:.8rem}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th{font-size:.75rem;text-align:left;color:#334155;font-weight:600}
    td{background:#fff;border:1px solid var(--line);padding:6px 8px;border-radius:8px;font-size:.8rem}

    /* Bottom nav */
    nav.bnv{
      height:var(--bnv);position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);
      display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr))
    }
    .tab{display:grid;place-items:center;gap:4px;color:#334155;font-size:.7rem;cursor:pointer;padding:6px}
    .tab.active{color:var(--brand-blue);font-weight:700}

    .fab{position:fixed;inset:auto calc(50% - 40px) 82px auto;width:80px;height:40px;border-radius:999px;background:var(--brand);display:flex;align-items:center;justify-content:center;gap:6px;font-weight:700;color:#0b2b27;border:1px solid #f2c93b;cursor:pointer;font-size:.85rem}
    .fab:active{transform:translateY(1px)}

    /* Event badges for history */
    .ev{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.72rem;font-weight:700;border:1px solid transparent}
    .ev.DELIVERED{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .ev.PICKED{background:#eff6ff;color:#1e40af;border-color:#c7d2fe}
    .ev.ACCEPTJOB{background:#f0f9ff;color:#075985;border-color:#bae6fd}
    .ev.REJECTJOB{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .ev.PICKUPDONE{background:#f5f3ff;color:#5b21b6;border-color:#ddd6fe}
    .ev.DELIVERYFAILED{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .ev.SCAN{background:#f1f5f9;color:#334155;border-color:#e2e8f0}

    /* History fit-to-screen */
    #tab-history { padding: 6px 12px 12px; }
    .hist-layout{height:calc(100dvh - var(--hdr) - var(--bnv));display:flex;flex-direction:column;gap:6px;}
    .hist-toolbar{position:sticky;top:0;z-index:3;background:#fff;border:1px solid var(--line);border-radius:12px;padding:6px;}
    .hist-bar,.hist-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .stat-cards.compact{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    .stat.compact{background:#f8fafc;border:1px solid var(--line);border-radius:10px;padding:6px;text-align:center}
    .stat.compact .num{font-weight:800;font-size:.95rem}
    .stat.compact .lbl{font-size:.7rem;color:#64748b}
    .hist-scroll{flex:1;min-height:0;overflow:auto;display:block}
    .card.hist-list{margin:0;padding:10px}
    .hist-scroll table thead th{position:sticky;top:0;z-index:1;background:#fff}
    #histTable td,#histTable th{padding:6px 8px;font-size:.78rem}
    #histTable td.muted{font-size:.75rem;color:#64748b}
    .empty{padding:16px;border:1px dashed var(--line);border-radius:10px;text-align:center;color:#64748b}

    /* Modal (Fullscreen) */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.58);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .sheet{width:100%;max-width:var(--maxw);height:92dvh;background:#fff;border-radius:20px;display:flex;flex-direction:column;overflow:hidden}
    .sheet header{position:relative}
    .sheet header h2{font-size:1rem;color:#0a2f8f}
    .sheet .body{flex:1;padding:16px;overflow:auto}

    /* Dark mode */
    @media (prefers-color-scheme: dark){
      body{background:#0b1020;color:#e5e7eb}
      .phone{background:#0f152a}
      header,.card,input,textarea,select,td{background:#0f152a;color:#e5e7eb;border-color:#223}
      nav.bnv{background:#0f152a;border-color:#223}
      .iconbtn{background:#0f152a;border-color:#223}
      .fab{border-color:#d4b534}
      .job{border-color:#223}
      .chip{background:#1b2035;border-color:#2a2f46;color:#cbd5e1}
      .chip[aria-pressed="true"]{background:#2b3a5a;border-color:#3c4b6c;color:#f0f6ff}
      .hist-toolbar{background:#0f152a;border-color:#223}
      .stat.compact{background:#101935;border-color:#223}
      .hist-scroll table thead th{background:#0f152a}
      .sheet{background:#0f152a}
    }
  </style>

<style>
/* ===== Auth (Login/Register) Overlay - Thunjai Express ===== */
.auth-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:9999;
  background:linear-gradient(180deg,var(--brand-blue) 0%, var(--brand-blue) 180px, var(--bg) 180px);}
.auth-card{width:100%;max-width:420px;background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,.15)}
.auth-hdr{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.auth-logo{inline-size:36px;block-size:36px;border-radius:10px;background:var(--brand);display:grid;place-items:center}
.auth-logo svg{width:20px;height:20px;color:var(--brand-blue)}
.auth-hdr h2{margin:0;font-size:1.1rem;color:var(--brand-blue)}
.auth-sub{margin:0 0 8px;color:var(--muted);font-size:.9rem}

.auth-tabs{display:flex;gap:6px;margin:6px 0 12px}
.auth-tab{flex:1;text-align:center;padding:10px;border:1px solid var(--line);background:#f9fafb;cursor:pointer;font-weight:700;border-radius:10px}
.auth-tab[aria-selected="true"]{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue)}

.auth-form{display:grid;gap:10px}
.auth-row{display:grid;gap:6px}
.auth-row.inline{grid-template-columns:1fr 1fr;gap:8px}
label{font-size:.86rem;color:#1f2937}
input[type="text"],input[type="tel"],input[type="password"],input[type="email"],input[type="number"]{
  padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink);font-size:.95rem}
input::placeholder{color:#94a3b8}
.auth-actions{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:2px}
.small-note{color:#64748b;font-size:.8rem}
a.auth-link{color:var(--brand-blue);font-weight:700;cursor:pointer;text-decoration:none}

.auth-btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;font-weight:800;font-size:.95rem;cursor:pointer}
.auth-btn.primary{background:var(--brand-blue);color:#fff}
.auth-btn.ghost{background:#fff;border:1px solid var(--line);color:var(--brand-blue)}

.auth-otp{display:flex;gap:8px}
.auth-otp input{flex:1;text-align:center;font-size:1.2rem;letter-spacing:.1em}

@media (prefers-color-scheme: dark){
  .auth-card{background:#0f162a;border-color:#243044;color:#e7edf6;box-shadow:0 10px 30px rgba(2,6,23,.6)}
  input[type="text"],input[type="tel"],input[type="password"],input[type="email"],input[type="number"]{
    background:#0f162a;border-color:#243044;color:#e7edf6}
  .auth-tab{background:#172033;border-color:#2a3650;color:#e5eaf3}
  .auth-tab[aria-selected="true"]{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue)}
}
</style>


<style>
/* ===== Auth Register fit-to-screen tweaks ===== */
.auth-card{max-height:92dvh; overflow:auto;}
.auth-overlay{overflow:auto;}

@supports (height: 100dvh){
  .auth-card{max-height:calc(100dvh - 24px);}
}

@media (max-width: 480px){
  .auth-overlay{
    align-items:flex-start; 
    padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom));
    overflow:auto;
  }
  .auth-card{
    width:100%; 
    max-width:none; 
    border-radius:14px; 
    padding:14px;
    max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 24px);
    overflow:auto;
  }
  .auth-tabs{margin-top:2px;}
  .auth-form{gap:10px}
  .auth-row.inline{grid-template-columns:1fr 1fr;gap:8px}
}

@media (max-width: 360px){
  .auth-row.inline{grid-template-columns:1fr;gap:6px}
  .auth-btn{padding:9px 10px; font-size:.9rem}
  label{font-size:.82rem}
  input[type="text"],input[type="tel"],input[type="password"],input[type="email"],input[type="number"]{
    font-size:.95rem; padding:10px 11px;
  }
}
</style>


<style>
/* ===== Register form: compact & polished ===== */
#panelRegister .auth-form{gap:10px}
#panelRegister .auth-row{gap:4px}
#panelRegister .auth-row.inline{gap:6px}

#panelRegister label{
  font-size:.82rem;
  color:#334155;
}

#panelRegister input[type="text"],
#panelRegister input[type="tel"],
#panelRegister input[type="password"],
#panelRegister input[type="email"],
#panelRegister input[type="number"]{
  padding:9px 10px;                 /* smaller height */
  font-size:.92rem;                  /* slightly smaller text */
  border-radius:9px;                 /* softer corners */
  background:#fafafa;                /* subtle background */
  border:1px solid var(--line);
  box-shadow:0 1px 0 rgba(15,23,42,.02); /* gentle depth */
  transition:background .2s, border-color .2s, box-shadow .2s;
}
#panelRegister input::placeholder{color:#94a3b8}
#panelRegister input:focus{background:#fff;border-color:#bfd7ff;box-shadow:0 0 0 3px rgba(191,215,255,.35)}

#panelRegister .auth-otp input{
  height:42px;
  font-size:1.05rem;
  border-radius:9px;
}

/* tighter on small screens */
@media (max-width: 480px){
  #panelRegister input[type="text"],
  #panelRegister input[type="tel"],
  #panelRegister input[type="password"],
  #panelRegister input[type="email"],
  #panelRegister input[type="number"]{
    padding:9px 10px;
    font-size:.9rem;
  }
  #panelRegister label{font-size:.8rem}
}

/* Dark mode polish */
@media (prefers-color-scheme: dark){
  #panelRegister label{color:#e2e8f0}
  #panelRegister input[type="text"],
  #panelRegister input[type="tel"],
  #panelRegister input[type="password"],
  #panelRegister input[type="email"],
  #panelRegister input[type="number"]{
    background:#0f162a;
    border-color:#243044;
    color:#e7edf6;
    box-shadow:0 1px 0 rgba(0,0,0,.2);
  }
  #panelRegister input:focus{background:#0f162a;border-color:#5d8dff;box-shadow:0 0 0 3px rgba(93,141,255,.28)}
  #panelRegister input::placeholder{color:#93a4c0}
  #panelRegister .auth-otp input{background:#0f162a;border-color:#243044;color:#e7edf6}
}
</style>


<style>
/* ===== Register form: ultra-compact, no-scroll fit ===== */
.auth-overlay{padding:8px; overflow:hidden; height:100dvh; display:flex; align-items:center; justify-content:center;}
.auth-card{max-height:none; height:auto; overflow:hidden; padding:12px 12px 12px; border-radius:14px;}
.auth-hdr{margin-bottom:4px}
.auth-sub{margin:0 0 6px}

#panelRegister .auth-form{gap:8px}
#panelRegister .auth-row{gap:2px}
#panelRegister .auth-row.inline{grid-template-columns:1fr 1fr; gap:6px}

#panelRegister label{font-size:.78rem; color:#334155; line-height:1.2}
#panelRegister input[type="text"],
#panelRegister input[type="tel"],
#panelRegister input[type="password"],
#panelRegister input[type="email"],
#panelRegister input[type="number"]{
  padding:8px 10px;
  font-size:.9rem;
  border-radius:8px;
}

#panelRegister .auth-otp input{
  height:38px;
  font-size:1rem;
  border-radius:8px;
}

/* Tabs, buttons, and links tighter */
.auth-tabs{margin:4px 0 8px}
.auth-tab{padding:8px; font-size:.92rem}
.auth-actions{gap:6px; flex-wrap:wrap}
.auth-btn{padding:9px 10px; font-size:.9rem}

/* Save height on small screens */
@media (max-width: 480px){
  .auth-sub{display:none}
  .auth-hdr h2{font-size:1rem}
  .auth-logo{inline-size:32px; block-size:32px}
}

/* Keep inline layout even on very small widths to reduce vertical growth */
@media (max-width: 360px){
  #panelRegister .auth-row.inline{grid-template-columns:1fr 1fr}
  #panelRegister label{font-size:.76rem}
  .auth-tab{padding:7px; font-size:.9rem}
  .auth-btn{padding:8px 9px; font-size:.88rem}
}
</style>

</head>
<body>

<!-- ===== AUTH OVERLAY ===== -->
<div id="authOverlay" class="auth-overlay" aria-hidden="true">
  <div class="auth-card">
    <div class="auth-hdr">
      <div class="auth-logo" aria-label="Thunjai Express">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2 3 14h7l-1 8 10-12h-7l1-8z"/></svg>
      </div>
      <h2>เข้าสู่ระบบ / ลงทะเบียน (Sender)</h2>
    </div>
    <p class="auth-sub">ล็อกอินหรือสมัครใหม่ด้วยเบอร์โทรและ OTP จากนั้นตั้งรหัสผ่านเพื่อใช้งานครั้งต่อไป</p>

    <div class="auth-tabs" role="tablist">
      <button id="tabLogin" class="auth-tab" role="tab" aria-selected="true" onclick="sxShowAuth('login')">เข้าสู่ระบบ</button>
      <button id="tabRegister" class="auth-tab" role="tab" aria-selected="false" onclick="sxShowAuth('register')">ลงทะเบียน</button>
    </div>

    <!-- Login Form -->
    <div id="panelLogin" class="auth-form" role="tabpanel">
      <div class="auth-row">
        <label for="sxLoginPhone">เบอร์โทรศัพท์</label>
        <input id="sxLoginPhone" type="tel" placeholder="เช่น 0812345678" inputmode="tel" />
      </div>
      <div class="auth-row">
        <label for="sxLoginPass">รหัสผ่าน</label>
        <input id="sxLoginPass" type="password" placeholder="รหัสผ่าน" />
      </div>
      <div class="auth-actions">
        <a class="auth-link" onclick="sxShowAuth('login-otp')">เข้าสู่ระบบด้วย OTP</a>
        <a class="auth-link" onclick="sxForgot()">ลืมรหัสผ่าน?</a>
      </div>
      <button class="auth-btn primary" onclick="sxLogin()">เข้าสู่ระบบ</button>
    </div>

    <!-- Login via OTP -->
    <div id="panelLoginOtp" class="auth-form" role="tabpanel" style="display:none">
      <div class="auth-row">
        <label for="sxLoginOtpPhone">เบอร์โทรศัพท์</label>
        <input id="sxLoginOtpPhone" type="tel" placeholder="เช่น 0812345678" inputmode="tel" />
      </div>
      <div class="auth-row">
        <button class="auth-btn ghost" onclick="sxRequestOTP('login')">ขอรหัส OTP</button>
      </div>
      <div class="auth-row">
        <label>รหัส OTP</label>
        <div class="auth-otp">
          <input id="sxLoginOTP" type="text" maxlength="6" placeholder="______" inputmode="numeric" />
        </div>
        <div class="small-note">ไม่ได้รับรหัส? <a class="auth-link" onclick="sxRequestOTP('login')">ส่งอีกครั้ง</a></div>
      </div>
      <button class="auth-btn primary" onclick="sxLoginWithOTP()">เข้าสู่ระบบด้วย OTP</button>
      <div class="auth-actions">
        <a class="auth-link" onclick="sxShowAuth('login')">กลับไปใช้รหัสผ่าน</a>
        <a class="auth-link" onclick="sxShowAuth('register')">ยังไม่มีบัญชี? สมัคร</a>
      </div>
    </div>

    <!-- Register Form -->
    <div id="panelRegister" class="auth-form" role="tabpanel" style="display:none">
      <div class="auth-row">
        <label for="sxRegPhone">เบอร์โทรศัพท์</label>
        <input id="sxRegPhone" type="tel" placeholder="เช่น 0812345678" inputmode="tel" />
      </div>
      <div class="auth-row">
        <button class="auth-btn ghost" onclick="sxRequestOTP('register')">ขอรหัส OTP</button>
      </div>
      <div class="auth-row">
        <label>รหัส OTP</label>
        <div class="auth-otp">
          <input id="sxRegOTP" type="text" maxlength="6" placeholder="______" inputmode="numeric" />
        </div>
      </div>
      <div class="auth-row inline">
        <div>
          <label for="sxRegPass">รหัสผ่าน</label>
          <input id="sxRegPass" type="password" placeholder="ตั้งรหัสผ่าน" />
        </div>
        <div>
          <label for="sxRegPass2">ยืนยันรหัสผ่าน</label>
          <input id="sxRegPass2" type="password" placeholder="ยืนยันรหัสผ่าน" />
        </div>
      </div>
      <div class="auth-row">
        <label for="sxRegName">ชื่อผู้ส่ง / ชื่อร้าน</label>
        <input id="sxRegName" type="text" placeholder="เช่น ร้านธันย์ใจ" />
      </div>
      <div class="auth-row inline">
        <div>
          <label for="sxRegEmail">อีเมล (ถ้ามี)</label>
          <input id="sxRegEmail" type="email" placeholder="example@mail.com" />
        </div>
        <div>
          <label for="sxRegAddress">ที่อยู่รับของหลัก (ย่อ)</label>
          <input id="sxRegAddress" type="text" placeholder="แขวง/เขต/จังหวัด" />
        </div>
      </div>
      <div class="small-note">การสมัครถือว่ายอมรับข้อตกลงการใช้บริการและนโยบายความเป็นส่วนตัว</div>
      <button class="auth-btn primary" onclick="sxRegister()">สมัครสมาชิก</button>
      <div class="auth-actions">
        <a class="auth-link" onclick="sxShowAuth('login')">มีบัญชีอยู่แล้ว? เข้าสู่ระบบ</a>
      </div>
    </div>
  </div>
</div>

  <div class="app">
    <div class="phone">
      <header>
        <div class="brand">
          <div class="logo" aria-label="Thunjai Express">
            <a href="home.html" class="logo" aria-label="Thunjai Express">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M13 2 3 14h7l-1 8 10-12h-7l1-8z"/>
      </svg>
    </a>
          </div>
          <div>
            <div class="role-chip">Role: Rider</div>
            <h1>Thunjai Express</h1>
          </div>
        </div>
        <div class="hdr-actions">
          <button class="iconbtn" title="โหมดทำงาน" onclick="toggleShift()">🟢</button>
          <button class="iconbtn" title="แจ้งเตือน" onclick="toast('ยังไม่มีแจ้งเตือนใหม่')">🔔</button>
          <button class="iconbtn" title="สแกน" onclick="openScan()">📷</button>
        </div>
      </header>

      <!-- TAB: Pickup -->
      <section id="tab-pickup" class="content active">
        <div class="grid">
          <div class="row">
            <h3>รับงาน (Pickup)</h3>
            <span class="pill" id="shiftState">On Duty</span>
          </div>
          <div class="row">
            <div class="chips" role="toolbar" aria-label="ตัวกรองสถานะ Pickup">
              <button class="chip" id="chip-Pickup-ALL"      aria-pressed="true"  onclick="setStatus('Pickup','ALL')">ALL (0)</button>
              <button class="chip" id="chip-Pickup-NEW"      aria-pressed="false" onclick="setStatus('Pickup','NEW')">NEW (0)</button>
              <button class="chip" id="chip-Pickup-ACCEPTED" aria-pressed="false" onclick="setStatus('Pickup','ACCEPTED')">ACCEPTED (0)</button>
              <button class="chip" id="chip-Pickup-PICKED"   aria-pressed="false" onclick="setStatus('Pickup','PICKED')">PICKED (0)</button>
              <button class="chip" id="chip-Pickup-DONE"     aria-pressed="false" onclick="setStatus('Pickup','DONE')">DONE (0)</button>
            </div>
            <button class="btn small ghost" onclick="sortJobs('Pickup')">จัดเส้นทาง</button>
          </div>
          <div class="card">
            <div class="row">
              <div class="muted">คิวรับ: <b id="cnt-Pickup">0</b> | เสร็จสิ้น: <b id="done-Pickup">0</b></div>
            </div>
          </div>
          <div id="jobList-Pickup" class="grid" style="gap:10px"></div>
        </div>
      </section>

      <!-- TAB: Delivery -->
      <section id="tab-delivery" class="content">
        <div class="grid">
          <div class="row">
            <h3>ส่งงาน (Delivery)</h3>
            <span class="pill">COD: <b id="earn">฿0</b></span>
          </div>
          <div class="row">
            <div class="chips" role="toolbar" aria-label="ตัวกรองสถานะ Delivery">
              <button class="chip" id="chip-Delivery-ALL"      aria-pressed="true"  onclick="setStatus('Delivery','ALL')">ALL (0)</button>
              <button class="chip" id="chip-Delivery-NEW"      aria-pressed="false" onclick="setStatus('Delivery','NEW')">NEW (0)</button>
              <button class="chip" id="chip-Delivery-ACCEPTED" aria-pressed="false" onclick="setStatus('Delivery','ACCEPTED')">ACCEPTED (0)</button>
              <button class="chip" id="chip-Delivery-PICKED"   aria-pressed="false" onclick="setStatus('Delivery','PICKED')">PICKED (0)</button>
              <button class="chip" id="chip-Delivery-DONE"     aria-pressed="false" onclick="setStatus('Delivery','DONE')">DONE (0)</button>
            </div>
            <button class="btn small ghost" onclick="sortJobs('Delivery')">จัดเส้นทาง</button>
          </div>
          <div class="card">
            <div class="row">
              <div class="muted">คิวส่ง: <b id="cnt-Delivery">0</b> | ส่งสำเร็จ: <b id="done-Delivery">0</b></div>
            </div>
          </div>
          <div id="jobList-Delivery" class="grid" style="gap:10px"></div>
        </div>
      </section>

      <!-- TAB: Route -->
      <section id="tab-route" class="content">
        <div class="card">
          <h3>เส้นทางวันนี้</h3>
          <p class="muted">*ตัวอย่างแผนที่ — สามารถเชื่อม Google Maps/Leaflet ได้</p>
          <div style="aspect-ratio:3/4;border:2px dashed var(--line);border-radius:14px;display:grid;place-items:center;margin-top:12px">🗺️ เส้นทาง/แผนที่</div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" onclick="toast('เริ่มนำทาง (ตัวอย่าง)')">เริ่มนำทาง</button>
            <button class="btn primary" onclick="sortJobs()">จัดลำดับจุดแวะ</button>
          </div>
        </div>
      </section>

      <!-- TAB: Scan -->
      <section id="tab-scan" class="content">
        <div class="card" style="margin-bottom:12px">
          <h3>สแกน / ประวัติ</h3>
          <div class="row">
            <button class="btn primary" onclick="openScan()">สแกนตอนรับ/ส่ง</button>
            <button class="btn ghost" onclick="clearScanLog()">ล้างประวัติ</button>
          </div>
        </div>
        <table>
          <thead><tr><th>เวลา</th><th>เลข</th><th>เหตุการณ์</th></tr></thead>
          <tbody id="scanLog"></tbody>
        </table>
      </section>

      <!-- TAB: History (ปรับตามที่ขอ) -->
      <section id="tab-history" class="content">
        <div class="hist-layout">

          <div class="hist-toolbar">
            <div class="hist-bar">
              <div class="row" style="gap:8px">
                <!-- ✅ เหลือแค่ช่องเลือกวันที่ -->
                <input id="histDate" type="date" />
                <input id="histSearch" type="search" placeholder="ค้นหา: เลขพัสดุ / ชื่อ / เบอร์ / ที่อยู่"
                       style="flex:1;min-width:180px;padding:9px 12px;border-radius:12px;border:1px solid var(--line)">
                <div class="row">
                  <button id="btnViewTimeline" class="btn small ghost" onclick="setHistView('timeline')">ลำดับเวลา</button>
                  <button id="btnViewGroup"    class="btn small ghost" onclick="setHistView('group')">จับกลุ่ม</button>
                </div>
              </div>
            </div>

            <!-- ✅ ปุ่มตัวกรองเล็กลง -->
            <div class="hist-row" style="margin-top:8px">
              <div id="histChips" class="chips small" role="toolbar" aria-label="ตัวกรองเหตุการณ์ (History)"></div>
              <div class="pill">จำนวนเหตุการณ์: <b id="histCnt">0</b></div>
            </div>
          </div>

          <div class="stat-cards compact">
            <div class="stat compact"><div class="num" id="statAll">0</div><div class="lbl">เหตุการณ์รวม</div></div>
            <div class="stat compact"><div class="num" id="statDelivered">0</div><div class="lbl">ส่งสำเร็จ</div></div>
            <div class="stat compact"><div class="num" id="statCOD">฿0</div><div class="lbl">COD รวมวัน</div></div>
          </div>

          <div class="hist-scroll">
            <div class="card hist-list">
              <div class="row" style="margin-bottom:6px">
                <h3 style="margin:0">รายการเหตุการณ์ <span class="muted" id="histDateLabel">—</span></h3>
              </div>

              <div id="histContainer">
                <table id="histTableWrap" style="width:100%">
                  <thead><tr><th>เวลา</th><th>เลขพัสดุ</th><th>ประเภท</th><th>เหตุการณ์</th><th>รายละเอียด</th><th>COD</th></tr></thead>
                  <tbody id="histTable"></tbody>
                </table>
              </div>

              <div id="histEmpty" class="empty" style="display:none">ไม่มีข้อมูลตามตัวกรองในวันนี้</div>
            </div>
          </div>

        </div>
      </section>

      <!-- TAB: COD -->
      <section id="tab-cod" class="content">
        <div class="grid">
          <div class="card">
            <h3>กระทบยอด COD</h3>
            <div class="row"><div class="big" id="codTotal">฿0</div><span class="pill">สะสมวันนี้</span></div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" onclick="reconcileCOD()">ส่งยอดเข้า Hub</button>
              <button class="btn ghost" onclick="toast('พิมพ์สลิป (ตัวอย่าง)')">พิมพ์สลิป</button>
            </div>
          </div>
          <div class="card">
            <h3>รายละเอียดลูกค้า (ล่าสุด)</h3>
            <div id="codList" class="muted">ยังไม่มีรายการ</div>
          </div>
        </div>
      </section>

      <!-- TAB: Profile -->
      <section id="tab-profile" class="content">
        <div class="grid">
          <div class="card">
            <h3>โปรไฟล์ไรเดอร์</h3>
            <div class="row"><span>ชื่อ</span><b>คุณธันย์ใจ</b></div>
            <div class="row"><span>ทะเบียนรถ</span><b>กข-1234</b></div>
            <div class="row"><span>ความจุ</span><b id="capacity">12 กล่อง</b></div>
            <div class="row"><span>พื้นที่</span><b>บางแค / ภาษีเจริญ</b></div>
          </div>
          <div class="card">
            <h3>ตั้งค่า</h3>
            <div class="row">
              <span>โหมดทำงาน</span>
              <button class="btn small ghost" onclick="toggleShift()">สลับ</button>
            </div>
            <div class="row">
              <span>รับออเดอร์อัตโนมัติ</span>
              <button class="btn small ghost" onclick="toast('เปิดใช้งาน (ตัวอย่าง)')">เปิด/ปิด</button>
            </div>
          </div>
        </div>
      </section>

      <button class="fab" onclick="openScan()">📷 สแกน</button>

      <!-- Bottom Nav -->
      <nav class="bnv" role="tablist" aria-label="เมนูหลัก">
        <div class="tab active" data-tab="pickup"   onclick="switchTab(this)">📦<span>Pickup</span></div>
        <div class="tab"         data-tab="delivery" onclick="switchTab(this)">🚚<span>Delivery</span></div>
        <div class="tab"         data-tab="route"    onclick="switchTab(this)">🗺️<span>เส้นทาง</span></div>
        <div class="tab"         data-tab="scan"     onclick="switchTab(this)">📷<span>สแกนสด</span></div>
        <div class="tab"         data-tab="history"  onclick="switchTab(this)">🗂️<span>ประวัติ</span></div>
        <div class="tab"         data-tab="cod"      onclick="switchTab(this)">💼<span>COD</span></div>
        <div class="tab"         data-tab="profile"  onclick="switchTab(this)">👤<span>โปรไฟล์</span></div>
      </nav>

      <!-- Fullscreen Modal: Scanner/Camera -->
      <div id="scanModal" class="modal" aria-hidden="true">
        <div class="sheet">
          <header>
            <div class="brand" style="padding:0 14px;gap:8px">
              <div class="logo"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2 3 14h7l-1 8 10-12h-7l1-8z"/></svg></div>
              <h2>สแกนพัสดุ / ถ่ายรูปหลักฐาน</h2>
            </div>
          </header>
          <div class="body">
            <div class="card" style="text-align:center">
              <p class="muted">*เดโม: ยังไม่เปิดกล้องจริง</p>
              <div style="aspect-ratio:16/9;border:2px dashed var(--line);border-radius:14px;display:grid;place-items:center;margin-top:12px">🔲 กล้อง</div>
              <div class="row" style="justify-content:center;margin-top:12px">
                <button class="btn ghost" onclick="closeScan()">ปิด</button>
                <button class="btn primary" onclick="mockScan()">สแกน</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ===== Utilities =====
    function switchTab(el){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
      el.classList.add('active')
      const tab = el.dataset.tab
      document.querySelectorAll('.content').forEach(s=>s.classList.remove('active'))
      document.getElementById('tab-'+tab).classList.add('active')
      document.getElementById('tab-'+tab).scrollTop = 0
    }
    function toast(msg){
      const t = document.createElement('div')
      t.textContent = msg
      t.style.cssText = 'position:fixed;left:50%;bottom:92px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;z-index:99'
      document.body.appendChild(t)
      setTimeout(()=>t.remove(), 1800)
    }
    const TH = 'th-TH'

    // ===== Shift =====
    let onDuty = true
    function toggleShift(){
      onDuty = !onDuty
      document.getElementById('shiftState').textContent = onDuty ? 'On Duty' : 'Off Duty'
      toast(onDuty ? 'เริ่มรับงาน' : 'หยุดรับงาน')
    }

    // ===== Data =====
    const jobs = [
      { id:'TJX1001', type:'Pickup',   name:'คุณนที', phone:'081-234-5678', addr:'ซ.สุขสวัสดิ์ 14, บางแค', note:'รับของ 2 กล่อง', cod:0,   status:'NEW' },
      { id:'TJX1002', type:'Delivery', name:'คุณดาว', phone:'089-222-1111', addr:'ซ.เอกชัย 55, บางบอน',   note:'ส่งด่วน',       cod:450, status:'NEW' },
      { id:'TJX1003', type:'Delivery', name:'คุณพร',  phone:'082-999-3344', addr:'พระราม 2 ซ.20',         note:'ของแตกหักง่าย', cod:0,   status:'ACCEPTED' },
      { id:'TJX1004', type:'Pickup',   name:'คุณบอส', phone:'081-777-2222', addr:'เพชรเกษม 69',            note:'1 กล่องเล็ก',   cod:0,   status:'PICKED' },
      { id:'TJX1005', type:'Delivery', name:'คุณกาน', phone:'081-345-9999', addr:'เอกชัย 76',              note:'COD',           cod:300, status:'PICKED' },
      { id:'TJX1006', type:'Pickup',   name:'คุณโบ',  phone:'080-333-2222', addr:'บางแคเหนือ',             note:'4 กล่อง',       cod:0,   status:'DONE' },
    ]
    let earn = 0
    const statusBySeg = { Pickup:'ALL', Delivery:'ALL' }
    const STATUSES = ['ALL','NEW','ACCEPTED','PICKED','DONE']

    // ===== History store =====
    const scanEvents = [] // {time:Date, id:string, event:string}

    // ===== Helpers =====
    function getRows(seg, st){
      let rows = jobs.filter(j=>j.type===seg)
      if(st && st!=='ALL') rows = rows.filter(j=>j.status===st)
      return rows
    }
    function countByStatus(seg){
      const all = jobs.filter(j=>j.type===seg)
      return {
        ALL: all.length,
        NEW: all.filter(j=>j.status==='NEW').length,
        ACCEPTED: all.filter(j=>j.status==='ACCEPTED').length,
        PICKED: all.filter(j=>j.status==='PICKED').length,
        DONE: all.filter(j=>j.status==='DONE').length,
      }
    }
    function updateChipCounts(seg){
      const c = countByStatus(seg)
      STATUSES.forEach(s=>{
        const chip = document.getElementById(`chip-${seg}-${s}`)
        if(chip){
          chip.innerText = `${s} (${c[s]})`
          chip.setAttribute('aria-pressed', statusBySeg[seg]===s ? 'true' : 'false')
        }
      })
    }
    function jobById(id){ return jobs.find(j=>j.id===id) }
    function jobByIdOrPartial(id){ return jobs.find(j=>j.id===id) || {} }

    function jobCardHTML(j){
      const isDelivery = j.type==='Delivery'
      const scanLabelAccepted = isDelivery ? 'สแกนส่งงาน' : 'สแกนรับงาน'
      return `
        <div class="job" id="job-${j.id}">
          <div class="row">
            <b>${j.id}</b>
            <span class="tag">${j.type}</span>
          </div>
          <div class="addr">📍 ${j.addr}</div>
          <div class="meta">
            <span class="tag">👤 ${j.name}</span>
            <span class="tag">📞 ${j.phone}</span>
            ${j.cod?`<span class="tag">COD ฿${j.cod}</span>`:''}
            <span class="tag">สถานะ: ${j.status}</span>
          </div>
          <div class="act">
            ${j.status==='NEW' ? `
              <button class="btn small primary" onclick="acceptJob('${j.id}')">รับงาน</button>
              <button class="btn small ghost"   onclick="rejectJob('${j.id}')">ปฏิเสธ</button>
            `: ''}
            ${j.status==='ACCEPTED' ? `
              <button class="btn small primary" onclick="updateJob('${j.id}','PICKED')">${scanLabelAccepted}</button>
              <button class="btn small ghost"   onclick="navigate('${j.id}')">นำทาง</button>
            `: ''}
            ${j.status==='PICKED' ? `
              ${isDelivery
                ? `<button class="btn small primary" onclick="deliver('${j.id}', true)">ส่งสำเร็จ</button>
                   <button class="btn small warn"    onclick="deliver('${j.id}', false)">ส่งไม่สำเร็จ</button>`
                : `<button class="btn small primary" onclick="finishPickup('${j.id}')">เสร็จสิ้นรับของ</button>`}
            `: ''}
            ${j.status==='DONE' ? `<span class="muted">ปิดงานแล้ว</span>`: ''}
          </div>
        </div>`
    }

    function renderSegment(seg){
      updateChipCounts(seg)
      const st = statusBySeg[seg]
      const rows = getRows(seg, st)

      const doneCnt = jobs.filter(j=>j.type===seg && j.status==='DONE').length
      const waitingCnt = rows.filter(j=>j.status!=='DONE').length
      document.getElementById(`cnt-${seg}`).textContent  = (st==='DONE') ? rows.length : waitingCnt
      document.getElementById(`done-${seg}`).textContent = doneCnt
      if(seg==='Delivery'){
        document.getElementById('earn').textContent = '฿'+ earn.toLocaleString(TH)
      }
      const box = document.getElementById(`jobList-${seg}`)
      box.innerHTML = rows.length ? rows.map(jobCardHTML).join('') : `<div class="muted">ไม่พบงานในสถานะที่เลือก</div>`
    }
    function renderAll(){ renderSegment('Pickup'); renderSegment('Delivery'); }

    // ===== Actions (with history log) =====
    function acceptJob(id){
      const j = jobById(id); if(!j) return
      j.status = 'ACCEPTED'
      renderAll(); logScan(j.id,'ACCEPT JOB')
    }
    function rejectJob(id){
      const idx = jobs.findIndex(x=>x.id===id); if(idx<0) return
      logScan(jobs[idx].id,'REJECT JOB')
      jobs.splice(idx,1)
      renderAll()
    }
    function updateJob(id, status){
      const j = jobById(id); if(!j) return
      j.status = status
      renderAll(); logScan(j.id,status) // 'PICKED'
    }
    function finishPickup(id){
      const j = jobById(id); if(!j) return
      j.status = 'DONE'
      renderAll(); logScan(j.id,'PICKUP DONE')
    }
    function deliver(id, success){
      const j = jobById(id); if(!j) return
      j.status = 'DONE'
      if(success){
        earn += j.cod||0
        document.getElementById('codTotal').textContent = '฿'+ earn.toLocaleString(TH)
        addCODCustomer(j)
      }
      renderAll(); logScan(j.id, success?'DELIVERED':'DELIVERY FAILED')
    }
    function navigate(id){
      const j = jobById(id); if(!j) return
      toast('เปิดนำทางไปยัง: '+ j.addr)
    }

    // ===== Filters per tab =====
    function setStatus(seg, st){
      if(!STATUSES.includes(st)) st='ALL'
      statusBySeg[seg] = st
      renderSegment(seg)
    }

    // ===== Scan modal & log =====
    function openScan(){ document.getElementById('scanModal').classList.add('open'); document.getElementById('scanModal').setAttribute('aria-hidden','false') }
    function closeScan(){ document.getElementById('scanModal').classList.remove('open'); document.getElementById('scanModal').setAttribute('aria-hidden','true') }
    function logScan(no, evt){
      const tb = document.getElementById('scanLog')
      const t  = new Date()
      const tStr = t.toLocaleString(TH)
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${tStr}</td><td>${no}</td><td>${evt}</td>`
      tb.prepend(tr)
      scanEvents.push({ time: t, id: no, event: evt })
      if(document.getElementById('tab-history').classList.contains('active')) renderHistory()
    }
    function mockScan(){
      closeScan(); toast('สแกนสำเร็จ (ตัวอย่าง)');
      logScan('TJX'+Math.random().toString(36).slice(2,7).toUpperCase(),'SCAN')
    }
    function clearScanLog(){
      document.getElementById('scanLog').innerHTML = ''
      scanEvents.length = 0
      if(document.getElementById('tab-history').classList.contains('active')) renderHistory()
    }

    // ===== COD =====
    function addCODCustomer(j){
      const box = document.getElementById('codList')
      if(box.textContent.includes('ยังไม่มีรายการ')) box.textContent=''
      const div = document.createElement('div')
      div.className='row'
      div.innerHTML = `<span>${j.id} • ${j.name}</span><b>฿${(j.cod||0).toLocaleString(TH)}</b>`
      box.appendChild(div)
    }
    function reconcileCOD(){
      const t = new Date().toLocaleString(TH)
      toast('ส่งยอด COD เข้า Hub แล้ว '+t)
    }

    // ===== History state & helpers =====
    const histEventOptions = [
      'ALL','DELIVERED','PICKED','ACCEPT JOB','REJECT JOB','PICKUP DONE','DELIVERY FAILED','SCAN'
    ]
    let histEventFilter = 'ALL'
    let histViewMode = 'timeline' // 'timeline' | 'group'
    let histSearchQuery = ''

    function yyyy_mm_dd(d){
      const y = d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0')
      return `${y}-${m}-${day}`
    }
    function parseDateInput(v){ return new Date(v+'T00:00') }
    function eventClass(name){
      const k = String(name).toUpperCase().replace(/\s+/g,'')
      return ['ev', k].join(' ')
    }

    function countEventsForDate(ymd){
      const res = {}; let all=0, delivered=0, cod=0
      scanEvents.forEach(e=>{
        if(yyyy_mm_dd(e.time)!==ymd) return
        all++
        res[e.event] = (res[e.event]||0)+1
        const j = jobByIdOrPartial(e.id)
        const isDelivery = (j.type==='Delivery')
        if(e.event==='DELIVERED' && isDelivery){
          delivered++
          cod += (j.cod||0)
        }
      })
      res.__ALL__ = all; res.__DELIVERED__ = delivered; res.__COD__ = cod
      histEventOptions.forEach(k=>{ if(!(k in res) && k!=='ALL') res[k]=0 })
      return res
    }

    function renderHistChips(){
      const ymd = document.getElementById('histDate').value
      const counts = countEventsForDate(ymd)
      const wrap = document.getElementById('histChips')
      wrap.innerHTML = histEventOptions.map(name=>{
        const n = name==='ALL' ? (counts.__ALL__||0) : (counts[name]||0)
        return `<button class="chip" data-name="${name}" aria-pressed="${histEventFilter===name?'true':'false'}"
                  onclick="setHistEventFilter('${name.replace(/'/g,"\\'")}')">${name} (${n})</button>`
      }).join('')
      document.getElementById('statAll').textContent = counts.__ALL__||0
      document.getElementById('statDelivered').textContent = counts.__DELIVERED__||0
      document.getElementById('statCOD').textContent = '฿'+ (counts.__COD__||0).toLocaleString(TH)
    }

    // ===== History interactions =====
    function setHistEventFilter(name){
      if(!histEventOptions.includes(name)) name='ALL'
      histEventFilter = name
      renderHistory()
    }
    function setHistView(mode){
      histViewMode = mode==='group' ? 'group' : 'timeline'
      document.getElementById('btnViewTimeline').className = 'btn small ' + (histViewMode==='timeline'?'primary':'ghost')
      document.getElementById('btnViewGroup').className    = 'btn small ' + (histViewMode==='group'?'primary':'ghost')
      renderHistory()
    }

    // ===== History render core =====
    function renderHistory(){
      const inp = document.getElementById('histDate')
      const sel = inp.value; if(!sel) return

      renderHistChips()

      let rowsAll = scanEvents.filter(e => yyyy_mm_dd(e.time)===sel)
                              .sort((a,b)=> b.time - a.time)

      const q = (histSearchQuery||'').trim().toLowerCase()
      if(q){
        rowsAll = rowsAll.filter(e=>{
          const j = jobByIdOrPartial(e.id)
          return [e.id, j.name, j.phone, j.addr].some(v => (v||'').toLowerCase().includes(q))
        })
      }

      const rows = histEventFilter==='ALL' ? rowsAll : rowsAll.filter(e=> e.event===histEventFilter)

      document.getElementById('histDateLabel').textContent =
        new Date(sel+'T00:00').toLocaleDateString(TH, {year:'numeric',month:'short',day:'numeric'})
      document.getElementById('histCnt').textContent = rows.length
      const empty = document.getElementById('histEmpty')
      const tableWrap = document.getElementById('histTableWrap')
      empty.style.display = rows.length ? 'none' : 'block'
      tableWrap.style.display = (rows.length && histViewMode==='timeline') ? '' : (histViewMode==='timeline'?'none':'')

      if(histViewMode==='timeline'){
        const tbody = document.getElementById('histTable')
        tbody.innerHTML = rows.map(e=>{
          const j = jobByIdOrPartial(e.id)
          const isDelivery = (j.type==='Delivery')
          const cod = (e.event==='DELIVERED' && isDelivery) ? (j.cod||0) : 0
          const lines = [
            j.note ? `โน้ต: ${j.note}` : '',
            j.addr ? `ที่อยู่: ${j.addr}` : ''
          ].filter(Boolean).join('<br>')
          return `<tr>
            <td>${e.time.toLocaleTimeString(TH,{hour:'2-digit',minute:'2-digit'})}</td>
            <td>${e.id}</td>
            <td>${j.type||'-'}</td>
            <td><span class="${eventClass(e.event)}">${e.event}</span></td>
            <td class="muted">${lines||'-'}</td>
            <td>${cod? '฿'+cod.toLocaleString(TH): '-'}</td>
          </tr>`
        }).join('')
      } else {
        const container = document.getElementById('histContainer')
        const groups = {}
        rows.forEach(e => { (groups[e.event] ||= []).push(e) })
        const ordered = histEventOptions.filter(s=>s!=='ALL').filter(s=>groups[s]?.length).concat(
          Object.keys(groups).filter(k=>!histEventOptions.includes(k))
        )
        container.innerHTML = ordered.length ? ordered.map(evt=>{
          const items = groups[evt].sort((a,b)=>b.time-a.time).map(e=>{
            const j = jobByIdOrPartial(e.id)
            const isDelivery = (j.type==='Delivery')
            const cod = (e.event==='DELIVERED' && isDelivery) ? (j.cod||0) : 0
            return `<div class="row" style="padding:8px 0;border-bottom:1px dashed var(--line)">
              <div style="min-width:72px">${e.time.toLocaleTimeString(TH,{hour:'2-digit',minute:'2-digit'})}</div>
              <div style="flex:1">
                <div><b>${e.id}</b> • <span class="muted">${j.type||'-'}</span></div>
                <div class="muted" style="font-size:.82rem">${j.addr||''}</div>
              </div>
              <div>${cod? '฿'+cod.toLocaleString(TH): ''}</div>
            </div>`
          }).join('')
          return `
            <div class="card" style="margin-top:10px">
              <div class="row"><h4 style="margin:0"><span class="${eventClass(evt)}">${evt}</span></h4><span class="pill">${groups[evt].length} รายการ</span></div>
              <div style="margin-top:6px">${items}</div>
            </div>`
        }).join('') : '<div class="empty">ไม่มีข้อมูลตามตัวกรองในวันนี้</div>'
        document.getElementById('histTable').innerHTML = ''
      }

      const counts = countEventsForDate(sel)
      document.getElementById('statAll').textContent = counts.__ALL__||0
      document.getElementById('statDelivered').textContent = counts.__DELIVERED__||0
      document.getElementById('statCOD').textContent = '฿'+ (counts.__COD__||0).toLocaleString(TH)
    }

    // ===== History bindings =====
    function bindHistoryUI(){
      const inp = document.getElementById('histDate')
      inp.value = yyyy_mm_dd(new Date())
      inp.addEventListener('change', ()=>{ renderHistory() })

      const search = document.getElementById('histSearch')
      let t=null
      search.addEventListener('input', e=>{
        clearTimeout(t)
        t = setTimeout(()=>{
          histSearchQuery = e.target.value||''
          renderHistory()
        }, 180)
      })

      setHistView('timeline')
      renderHistory()
    }

    // ===== Sorting demo =====
    function sortJobs(seg){
      if(!seg){
        jobs.sort((a,b)=> (a.type==='Delivery') - (b.type==='Delivery'))
      }else{
        const order = {NEW:1, ACCEPTED:2, PICKED:3, DONE:4}
        jobs.sort((a,b)=>{
          if(a.type!==seg || b.type!==seg) return 0
          return (order[a.status]||9) - (order[b.status]||9)
        })
      }
      renderAll()
      toast('จัดลำดับ (ตัวอย่าง)')
    }

    // ===== Init =====
    renderAll()
    bindHistoryUI()
  </script>

<script>
/* ===== Auth Logic (Demo) ===== */
(function(){
  const LS_KEY = 'sx_auth';
  let pendingOTP = null;

  function $(id){ return document.getElementById(id); }
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = 'position:fixed;left:50%;bottom:92px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:.96;z-index:10000';
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 1800);
  }

  window.sxLogout = function(){
    localStorage.removeItem(LS_KEY);
    showOverlay(true);
    toast('ออกจากระบบแล้ว');
  }

  function isAuthed(){
    try{ return !!JSON.parse(localStorage.getItem(LS_KEY)||'null'); }catch(e){ return false; }
  }
  function showOverlay(show){
    const ov = $('authOverlay');
    ov.style.display = show ? 'flex' : 'none';
    ov.setAttribute('aria-hidden', show ? 'false' : 'true');
    const app = document.querySelector('.app') || document.querySelector('.phone') || document.body;
    if(app && show){ app.style.pointerEvents = 'none'; app.style.filter = 'blur(1px)'; }
    if(app && !show){ app.style.pointerEvents = ''; app.style.filter = ''; }
  }

  window.sxShowAuth = function(mode){
    const tabLogin = $('tabLogin'), tabRegister = $('tabRegister');
    function sel(tab, on){ tab && tab.setAttribute('aria-selected', on?'true':'false'); }
    const pLogin = $('panelLogin'), pLoginOtp = $('panelLoginOtp'), pReg = $('panelRegister');
    pLogin.style.display = 'none'; pLoginOtp.style.display = 'none'; pReg.style.display = 'none';
    if(mode==='login'){ sel(tabLogin,true); sel(tabRegister,false); pLogin.style.display='grid'; }
    else if(mode==='login-otp'){ sel(tabLogin,true); sel(tabRegister,false); pLoginOtp.style.display='grid'; }
    else { sel(tabLogin,false); sel(tabRegister,true); pReg.style.display='grid'; }
  }

  window.sxRequestOTP = function(flow){
    pendingOTP = String(Math.floor(100000 + Math.random()*900000));
    console.log('DEMO OTP =', pendingOTP);
    toast('ส่งรหัส OTP แล้ว (เดโม)');
  }

  window.sxLogin = function(){
    const phone = $('sxLoginPhone').value.trim();
    const pass  = $('sxLoginPass').value.trim();
    if(!/^0\d{9}$/.test(phone)) return toast('กรอกเบอร์โทร 10 หลัก');
    if(pass.length < 6) return toast('รหัสผ่านอย่างน้อย 6 ตัว');
    localStorage.setItem(LS_KEY, JSON.stringify({ phone, name:'ผู้ส่ง', method:'password' }));
    showOverlay(false);
    toast('เข้าสู่ระบบสำเร็จ');
  }

  window.sxLoginWithOTP = function(){
    const phone = $('sxLoginOtpPhone').value.trim();
    const code  = $('sxLoginOTP').value.trim();
    if(!/^0\d{9}$/.test(phone)) return toast('กรอกเบอร์โทร 10 หลัก');
    if(!pendingOTP) return toast('กรุณาขอรหัส OTP ก่อน');
    if(code !== pendingOTP) return toast('รหัส OTP ไม่ถูกต้อง');
    localStorage.setItem(LS_KEY, JSON.stringify({ phone, name:'ผู้ส่ง', method:'otp' }));
    showOverlay(false);
    toast('เข้าสู่ระบบด้วย OTP สำเร็จ');
  }

  window.sxRegister = function(){
    const phone = $('sxRegPhone').value.trim();
    const code  = $('sxRegOTP').value.trim();
    const p1    = $('sxRegPass').value.trim();
    const p2    = $('sxRegPass2').value.trim();
    const name  = $('sxRegName').value.trim() || 'ผู้ส่ง';
    const email = $('sxRegEmail').value.trim();
    const addr  = $('sxRegAddress').value.trim();
    if(!/^0\d{9}$/.test(phone)) return toast('กรอกเบอร์โทร 10 หลัก');
    if(!pendingOTP) return toast('กรุณาขอรหัส OTP');
    if(code !== pendingOTP) return toast('รหัส OTP ไม่ถูกต้อง');
    if(p1.length < 6) return toast('รหัสผ่านอย่างน้อย 6 ตัว');
    if(p1 !== p2) return toast('รหัสผ่านไม่ตรงกัน');
    localStorage.setItem(LS_KEY, JSON.stringify({ phone, name, email, addr, method:'register' }));
    showOverlay(false);
    toast('สมัครสมาชิกสำเร็จ');
  }

  window.sxForgot = function(){
    sxShowAuth('login-otp');
    $('sxLoginOtpPhone').value = $('sxLoginPhone').value;
    sxRequestOTP('login');
    toast('กรุณากรอกรหัส OTP เพื่อตั้งรหัสผ่านใหม่ (เดโม)');
  }

  document.addEventListener('DOMContentLoaded', function(){
    if(!isAuthed()) showOverlay(true);
    else showOverlay(false);
    sxShowAuth('register');
  });
})();
</script>

</body>
</html>
